import java.io.*;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.Scanner;

public class Main {

    private static final int PORT = 1234;
    private static boolean end_client = false;

    public static void main(String[] args) {
        System.out.println("1. Join a Game");
        System.out.println("2. Host a Game");
        System.out.print("Choose an option: ");

        try (Scanner scanner = new Scanner(System.in)) {
            int option = scanner.nextInt();

            if (option == 1) {
                scanner.nextLine(); // Consume the newline character
                System.out.print("Enter your name: ");
                String playerName = scanner.nextLine();
                System.out.print("Enter the other player's IP address: ");
                String otherPlayerIP = scanner.nextLine();
                connectToOtherPlayer(playerName, otherPlayerIP);
            } else if (option == 2) {
                scanner.nextLine(); // Consume the newline character
                System.out.print("Enter your name: ");
                String playerName = scanner.nextLine();
                startServer(playerName);
            } else {
                System.out.println("Invalid option. Exiting.");
            }
        }
    }

    private static void connectToOtherPlayer(String playerName, String otherPlayerIP) {
        try (Socket socket = new Socket(otherPlayerIP, PORT)) {
            System.out.println("Connected to the other player.");

            // Start a thread to handle incoming messages
            new Thread(() -> handleIncomingMessages(socket)).start();

            // Send messages to the other player
            try (PrintWriter writer = new PrintWriter(socket.getOutputStream(), true)) {
                while (!end_client) {
                    System.out.print("[" + playerName + "] Enter message: ");
                    String message = new Scanner(System.in).nextLine();
                    writer.println(message);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static void startServer(String playerName) {
        try (ServerSocket serverSocket = new ServerSocket(PORT)) {
            System.out.println("Waiting for the other player to connect...");
            System.out.println("Your IP address is: " + getLocalIpAddress());

            Socket socket = serverSocket.accept();
            System.out.println("The other player connected.");

            // Start a thread to handle incoming messages
            new Thread(() -> handleIncomingMessages(socket)).start();

            // Send messages to the other player
            try (PrintWriter writer = new PrintWriter(socket.getOutputStream(), true)) {
                while (!end_client) {
                    System.out.print("[" + playerName + "] Enter message: ");
                    String message = new Scanner(System.in).nextLine();
                    writer.println(playerName + ": " + message);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static String getLocalIpAddress() {
        try (Socket socket = new Socket("google.com", 80)) {
            return socket.getLocalAddress().getHostAddress();
        } catch (IOException e) {
            e.printStackTrace();
            return "N/A";
        }
    }

    private static void handleIncomingMessages(Socket socket) {
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                if(line.equals("end")) {
                    end_client = true;
                    System.out.println("ejeirehuehjzaiezhjaezahjeizaheziehjea");
                }
            }
        } catch (IOException e) {
            // Handle the exception or ignore it
        } finally {
            try {
                socket.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
