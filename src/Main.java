import org.fusesource.jansi.AnsiConsole;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.Scanner;

public class Main {

    private static final int PORT = 1234;
    private static boolean end_client = false;
    private static String testing_attack = "";
    public static void delayedOutput(String output){

        for(int k = 0;k<output.length();k++){
            try {
                Thread.sleep(3);

            } catch (InterruptedException ignored) {}
            System.out.print(output.charAt(k));
        }
        System.out.print("\n");

    }
    public static void delayedOutput(String output, int delay){

        for(int k = 0;k<output.length();k++){

            try {
                Thread.sleep(delay);

            } catch (InterruptedException ignored) {}
            System.out.print(output.charAt(k));
        }
        System.out.print("\n");
    }

    public static void main(String[] args) {
        AnsiConsole.systemInstall();

        System.out.println("1. Join a Game");
        System.out.println("2. Host a Game");
        System.out.print("Choose an option: ");

        try (Scanner scanner = new Scanner(System.in)) {
            int option = scanner.nextInt();

            if (option == 1) {
                scanner.nextLine();
                System.out.print("Entrez votre prénom: ");
                String playerName = scanner.nextLine();
                System.out.print("Entrez l'adresse IP de votre adversaire: ");
                String otherPlayerIP = scanner.nextLine();
                connectToOtherPlayer(playerName, otherPlayerIP);
            } else if (option == 2) {
                scanner.nextLine();
                System.out.print("Entrez le nom de votre entreprise ");
                String playerName = scanner.nextLine();
                delayedOutput("Vous devez \u001B[34mdéfendre\u001B[0m votre entreprise contre les \u001B[31mattaques\u001B[0m des" +
                        "\nméchants \u001B[33mh4ck3rs\u001B[0m. Vous avez un budget \u001B[33mlimité\u001B[0m qui augmente d'exactement " +
                        "\n$1 toutes les 3 secondes. Mais \u001B[31mattention\u001B[0m car les \u001B[33mh4ck3rs\u001B[0m" +
                        "\npeuvent vous voler votre argent. Bon courage!");
                simulateBlinkingCursor();
                simulateBlinkingCursor();
                startServer(playerName);
            } else {
                System.out.println("Invalid option. Exiting.");
            }
        }
    }

    public static void Testing_attack() {
        System.out.println("Votre entreprise est touchée par u");

    }

    private static void check_attack() throws InterruptedException {
        if(!testing_attack.isEmpty()) {
            delayedOutput("\u001B[31m__________ATTAQUE EN COURS__________", 30);

        }
        switch (testing_attack){

            case "":
                break;

            case "ransomware":
                delayedOutput("> Attaque: Ransomware", 40);
                simulateBlinkingCursor();
                delayedOutput("> Montant de la rançon: $10\u001B[0m", 40);
                simulateBlinkingCursor();
                DefenseManager.budget -= 10;
                if(DefenseManager.budget<10){
                    delayedOutput("Vous êtes désormais \u001B[31mendetté\u001B[0m. Vous devez attendre avant de rembourser la dette.");
                    delayedOutput("Veuillez patienter le temps que votre budget remonte...");
                    while(DefenseManager.budget<0){
                        Thread.sleep(3000);
                        System.out.println("Budget: " + DefenseManager.budget);
                    }
                }
                System.out.println("to");
                break;
        }
        testing_attack = "";


    }

    private static void connectToOtherPlayer(String playerName, String otherPlayerIP) {
        try (Socket socket = new Socket(otherPlayerIP, PORT)) {
            System.out.println("Connected to the other player.");

            new Thread(() -> handleIncomingMessages(socket)).start();
            boolean done = false;
            String attaque = "";
            while(!done) {
                System.out.println("Lancez une attaque parmis les suivantes:");
                System.out.println("[1] - Ransomware\n[2] - Reconnaissance\n[3] - Ddos\n");

                attaque = new Scanner(System.in).nextLine();
                ExploitFramework ef = new ExploitFramework();

                switch (attaque) {

                    case "1":
                        attaque = "test_attack";
                        break;

                    case "2":

                        break;

                    case "3":

                        break;

                    default:
                        break;

                }

                try (PrintWriter writer = new PrintWriter(socket.getOutputStream(), true)) {
                    writer.println(attaque);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }    public static void simulateBlinkingCursor() {
        boolean cursorVisible = true;

        for (int i = 0; i < 6; i++) {
            System.out.print("\r");

            if (cursorVisible) {
                System.out.print("█");
            } else {
                System.out.print(" ");
            }

            cursorVisible = !cursorVisible;

            try {
                Thread.sleep(150);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }

    private static void startServer(String playerName) {
        try (ServerSocket serverSocket = new ServerSocket(PORT)) {
            System.out.println("En attente d'adversaire...");
            System.out.println("Votre adresse IP est: " + getLocalIpAddress());

            Socket socket = serverSocket.accept();
            System.out.println("Connexion effectuée.");
            DefenseManager defman = new DefenseManager();
            new Thread(() -> handleIncomingMessages(socket)).start();

            boolean done = false;
            while(!done) {
                check_attack();

                delayedOutput(defman.print_info(), 1);
                simulateBlinkingCursor();
                delayedOutput("Installez une défense parmis les suivantes:");
                delayedOutput("\u001B[34mAntivirus__________\u001B[0m");
                delayedOutput("[1] - Ariva economy \u001B[36m$" +new AntivirusLevel1().getPrice()+ "\u001B[0m "+defman.printIsInstalled(new AntivirusLevel1()));
                delayedOutput("[2] - AI Protect Pro \u001B[36m$" +new AntivirusLevel2().getPrice()+ "\u001B[0m "+defman.printIsInstalled(new AntivirusLevel2()));
                delayedOutput("[3] - CyberSecure MegaDefender 9000 Ultra Turbo Extreme Edition \u001B[36m$" +new AntivirusLevel3().getPrice()+ "\u001B[0m"+defman.printIsInstalled(new AntivirusLevel3())+" \n");

                delayedOutput("\u001B[33mFirewall__________\u001B[0m");
                delayedOutput("[4] - Bicrosoft Firewall \u001B[36m$" + new FirewallLevel1().getPrice() + "\u001B[0m " + defman.printIsInstalled(new FirewallLevel1()));
                delayedOutput("[5] - FenceGuard lite \u001B[36m$" + new FirewallLevel2().getPrice() + "\u001B[0m " + defman.printIsInstalled(new FirewallLevel2()));
                delayedOutput("[6] - FortressPro Elite Security Suite \u001B[36m$" + new FirewallLevel3().getPrice() + "\u001B[0m " + defman.printIsInstalled(new FirewallLevel3()) + " \n");

                delayedOutput("\u001B[35mChiffrement__________\u001B[0m");
                delayedOutput("[7] - SecureLite Encryptor \u001B[36m$" + new ChiffrementLevel1().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ChiffrementLevel1()));
                delayedOutput("[8] - CipherGuard 360 Standard Edition \u001B[36m$" + new ChiffrementLevel2().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ChiffrementLevel2()));
                delayedOutput("[9] - QuantumShield Pro Cryptographic Suite, Maximum Edition \u001B[36m$" + new ChiffrementLevel3().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ChiffrementLevel3()) + " \n");

                delayedOutput("\u001B[32mFurtivité__________\u001B[0m");
                delayedOutput("[10] - SudVPN \u001B[36m$" + new ObfuscLevel1().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ObfuscLevel1()));
                delayedOutput("[11] - CipherGuard 360 Standard Edition \u001B[36m$" + new ObfuscLevel2().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ObfuscLevel2()));
                delayedOutput("[12] - QuantumCloak Pro Stealth Enhancer Supreme Ultra Mega Cybernetic Guardian \u001B[36m$" + new ObfuscLevel3().getPrice() + "\u001B[0m " + defman.printIsInstalled(new ObfuscLevel3()) + " \n");

                simulateBlinkingCursor();
                System.out.print("\nadmin@"+playerName+":~#");

                String software = new Scanner(System.in).nextLine();

                switch (software) {

                    case "1":
                        defman.installSoftware(new AntivirusLevel1());
                        break;

                    case "2":
                        defman.installSoftware(new AntivirusLevel2());
                        break;

                    case "3":
                        defman.installSoftware(new AntivirusLevel3());
                        break;

                    case "4":
                        defman.installSoftware(new FirewallLevel1());
                        break;

                    case "5":
                        defman.installSoftware(new FirewallLevel2());
                        break;

                    case "6":
                        defman.installSoftware(new FirewallLevel3());
                        break;

                    case "7":
                        defman.installSoftware(new ChiffrementLevel1());
                        break;

                    case "8":
                        defman.installSoftware(new ChiffrementLevel2());
                        break;

                    case "9":
                        defman.installSoftware(new ChiffrementLevel3());
                        break;

                    case "10":
                        defman.installSoftware(new ObfuscLevel1());
                        break;

                    case "11":
                        defman.installSoftware(new ObfuscLevel2());
                        break;

                    case "12":
                        defman.installSoftware(new ObfuscLevel3());
                        break;




                    case "13":
                        done = true;
                        break;

                    default:
                        break;

                }

            }

            System.out.println(defman.getInstalledSoftware());
            defman.getScores();

        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
        }
    }

    private static String getLocalIpAddress() {
        try (Socket socket = new Socket("google.com", 80)) {
            return socket.getLocalAddress().getHostAddress();
        } catch (IOException e) {
            e.printStackTrace();
            return "N/A";
        }
    }

    private static void handleIncomingMessages(Socket socket) {
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                if(line.equals("test_attack")) {
                    testing_attack = "ransomware";
                }
            }
        } catch (IOException ignored) {}
        finally {
            try {
                socket.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
